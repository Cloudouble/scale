<style>
:host {
    contain: content;
    display: block;
    position: relative;
}
:host > .viewer, :host > .editor {
    display: none;
}
</style>
<template>
    <div name="viewer"></div>
    <div name="editor"></div>
</template>
<script>
    /* global */
    class OpaqueData extends window.LiveElement.Element.elements.HTMLElement {

        static __extends = 'HTMLElement'

        constructor() {
            super()
            var $this = this
            
        }

        static get observedAttributes() {
            return (super.observedAttributes || []).concat('Content-Length', 'Content-Type', 'Last-Modified', 'path', 'body', 'mode')
        }
        
        connectedCallback() {
            var $this = this
        }
        
        setParam(name, value) {
            var $this = this
            if ($this.mode != 'editor') {
                var isNewParam, isNewObject, viewerElement = $this.shadowRoot.querySelector('div[name="viewer"]') 
                var paramElement = viewerElement.querySelector(`object param[name=${name}]`) || document.createElement('param')
                if (!paramElement.hasAttribute('name')) {
                    paramElement.setAttribute('name', name)
                    isNewParam = true
                }
                paramElement.setAttribute('value', value)
                if (isNewParam) {
                    var objectElement = viewerElement.querySelector('object')
                    if (!objectElement) {
                        objectElement = document.createElement('object')
                        isNewObject = true
                    }
                    objectElement.appendChild(paramElement)
                    if (isNewObject) {
                        viewerElement.appendChild(objectElement)
                    }
                }
            }
        }
        
        setImageEditorProperty(name, value) {
            var $this = this
            if ($this.mode != 'viewer') {
                var contentBase = ((name == 'contenttype' ? value : $this['Content-Type']) || '').split('/')[0]
                var editorElement = $this.shadowRoot.querySelector('div[name="editor"]')
                if (contentBase == 'image') {
                    var imageEditorElement = editorElement.querySelector('element-imageeditor')
                    if (!imageEditorElement) {
                        imageEditorElement = document.createElement('element-imageeditor')
                        editorElement.appendChild(imageEditorElement)
                    }
                    imageEditorElement[name] = value
                }
            }
        }
        
        ['Content-Length']($this, value) {
            $this.setParam('Content-Length', value)
            $this.setImageEditorProperty('size', value)
            return value
        }
        
        ['Content-Type']($this, value) {
            if ($this.mode != 'editor') {
                var viewerElement = $this.shadowRoot.querySelector('div[name="viewer"]'), editorElement = $this.shadowRoot.querySelector('div[name="editor"]') 
                var objectElement = viewerElement.querySelector('object')
                if (objectElement) {
                    objectElement.setAttribute('type', value)
                }
            }
            $this.setImageEditorProperty('contenttype', value)
            return value
        }
        
        ['Last-Modified']($this, value) {
            $this.setParam('Last-Modified', value)
            return value
        }
        
        path($this, value) {
            $this.setParam('path', value)
            return value
        }
        
        body($this, value) {
            var contentBase = ($this['Content-Type'] || '').split('/')[0], editorElement = $this.shadowRoot.querySelector('div[name="editor"]')
            var dataURL = `data:${$this['Content-Type']};base64,${value}`
            if ($this.mode != 'editor') {
                var isNew, viewerElement = $this.shadowRoot.querySelector('div[name="viewer"]')
                var objectElement = viewerElement.querySelector('object')
                if (!objectElement) {
                    objectElement = document.createElement('object')
                    isNew = true
                }
                objectElement.setAttribute('data', dataURL)
                if (isNew) {
                    viewerElement.appendChild(objectElement)
                }
                if ($this['Content-Type']) {
                    if (contentBase == 'image') {
                        var imageEditorElement = editorElement.querySelector('element-imageeditor')
                        if (!imageEditorElement) {
                            imageEditorElement = document.createElement('element-imageeditor')
                            editorElement.appendChild(imageEditorElement)
                        }
                        var imgElement = document.createElement('img')
                        imgElement.setAttribute('src', dataURL)
                    }
                }
            }
            if ($this.mode != 'viewer') {
                if (contentBase == 'image') {
                    var imageEditorElement = editorElement.querySelector('element-imageeditor')
                    if (!imageEditorElement) {
                        imageEditorElement = document.createElement('element-imageeditor')
                        editorElement.appendChild(imageEditorElement)
                    }
                    var imgElement = document.createElement('img')
                    imgElement.setAttribute('src', dataURL)
                    imageEditorElement.appendChild(imgElement)
                }
            }
        }
        
        mode($this, value) {
            $this.shadowRoot.querySelectorAll(':scope > div').forEach(divElement => {
                divElement.removeAttribute('style')
            })
            var divElements = value ? $this.shadowRoot.querySelectorAll(`:scope > div[name="${value}"]`) : $this.shadowRoot.querySelectorAll(`:scope > div`)
            divElements.forEach(divElement => {
                divElement.setAttribute('style', 'display: block;')
            })
            return value
        }
        
    }
</script>
