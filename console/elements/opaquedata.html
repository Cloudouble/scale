<style>
:host {
    contain: content;
    display: block;
    position: relative;
}
</style>
<template>
    <div name="viewer"></div>
    <div name="editor"></div>
</template>
<script>
    /* global */
    class OpaqueData extends window.LiveElement.Element.elements.HTMLElement {

        static __extends = 'HTMLElement'

        constructor() {
            super()
            var $this = this
            $this.textEditorId = Math.floor(Math.random()*1000000000)
        }

        static get observedAttributes() {
            return (super.observedAttributes || []).concat('Content-Length', 'Content-Type', 'Last-Modified', 'path', 'body', 'mode', 'editorType')
        }
        
        connectedCallback() {
            var $this = this
        }
        
        setParam(name, value) {
            var $this = this
            if ($this.mode != 'editor') {
                var isNewParam, isNewObject, viewerElement = $this.shadowRoot.querySelector('div[name="viewer"]')
                var paramElement = viewerElement.querySelector(`object param[name=${name}]`) || document.createElement('param')
                if (!paramElement.hasAttribute('name')) {
                    paramElement.setAttribute('name', name)
                    isNewParam = true
                }
                paramElement.setAttribute('value', value)
                if (isNewParam) {
                    var objectElement = viewerElement.querySelector('object')
                    if (!objectElement) {
                        objectElement = document.createElement('object')
                        isNewObject = true
                    }
                    objectElement.appendChild(paramElement)
                    if (isNewObject) {
                        viewerElement.appendChild(objectElement)
                    }
                }
            }
        }
        
        ['Content-Length']($this, value) {
            $this.setParam('Content-Length', value)
            $this.setImageEditorProperty('size', value/1024)
            return value
        }
        
        ['Content-Type']($this, value) {
            if ($this.mode != 'editor') {
                var viewerElement = $this.shadowRoot.querySelector('div[name="viewer"]'), objectElement = viewerElement.querySelector('object')
                if (objectElement) {
                    objectElement.setAttribute('type', value)
                }
            }
            var contentBase = value.split('/')[0]
            if (contentBase == 'image') {
                $this.editorType = 'image'
                $this.setImageEditorProperty('contenttype', value)
            } else {
                $this.modelist = $this.modelist || window.ace.require('ace/ext/modelist')
                $this.aceMode = $this.modelist.getModeForPath(`test.${($this.constructor.contentTypesMap[value] || {suffix: 'bin'}).suffix }`).mode
                if ($this.aceMode != 'ace/mode/text' || contentBase == 'text') { 
                    $this.editorType = 'text'
                } else {
                    $this.editorType = 'upload'
                }
            }
            return value
        }
        
        ['Last-Modified']($this, value) {
            $this.setParam('Last-Modified', value)
            return value
        }
        
        path($this, value) {
            $this.setParam('path', value)
            if (!$this['Content-Type']) {
                var suffix = value.split('.').pop()
                $this['Content-Type'] = (([['application/octet-stream']]).concat(Object.entries($this.constructor.contentTypesMap).filter(entry => entry[1].suffix == suffix)))[0][0]
            }
            return value
        }
        
        body($this, value) {
            $this.dataURL = `data:${$this['Content-Type']};base64,${value}`
            if ($this.mode != 'editor') {
                var isNew, viewerElement = $this.shadowRoot.querySelector('div[name="viewer"]'), objectElement = viewerElement.querySelector('object')
                if (!objectElement) {
                    objectElement = document.createElement('object')
                    isNew = true
                }
                objectElement.setAttribute('data', $this.dataURL)
                if ($this['Content-Type']) {
                    objectElement.setAttribute('type', $this['Content-Type'])
                }
                if (isNew) {
                    viewerElement.appendChild(objectElement)
                }
            }
            if ($this.mode != 'viewer') {
                $this.createEditor()
            }
        }
        
        mode($this, value) {
            $this.querySelectorAll(':scope > div').forEach(divElement => {
                divElement.removeAttribute('style')
            })
            var divElements = value ? $this.querySelectorAll(`:scope > div[name="${value}"]`) : $this.querySelectorAll(`:scope > div`)
            divElements.forEach(divElement => {
                divElement.setAttribute('style', 'display: block;')
            })
            return value
        }
        
        editorType($this, value) {
            if ($this.mode != 'viewer') {
                $this.createEditor(value)
            }
            return value
        }
        
        createEditor(editorType) {
            var $this = this
            editorType = editorType || $this.editorType
            var editorElement = $this.shadowRoot.querySelector('div[name="editor"]')
            if ($this.editor && $this.editorType && editorType && editorType != $this.editorType) {
                if (typeof $this.editor.remove == 'function') {
                    $this.editor.remove()
                } else if (typeof $this.editor.destroy == 'function') {
                    $this.editor.destroy()
                    var oldTextEditorElement = document.getElementById($this.textEditorId)
                    if (oldTextEditorElement) {
                        oldTextEditorElement.remove()
                    }
                }
            } 
            if (editorType == 'image') {
                var imageEditorElement = editorElement.querySelector('element-imageeditor')
                if (!imageEditorElement) {
                    imageEditorElement = document.createElement('element-imageeditor')
                    editorElement.appendChild(imageEditorElement)
                }
                $this.editor = imageEditorElement
                if ($this.dataURL) {
                    var imgElement = document.createElement('img')
                    imgElement.setAttribute('src', $this.dataURL)
                    imageEditorElement.appendChild(imgElement)
                }
            } else if (editorType == 'text') {
                var attachTextEditor = function() {
                    if (!$this.textEditorElement) {
                        $this.textEditorElement = document.createElement('div')
                        $this.textEditorElement.setAttribute('id', $this.textEditorId)
                        $this.textEditorElement.classList.add('text-editor')
                        //$this.appendChild($this.textEditorElement)
                        //editorElement.appendChild($this.textEditorElement)
                        $this.after($this.textEditorElement)
                    }
                    $this.editor = window.ace.edit($this.textEditorElement)
                    $this.editor.setOptions({...window.LiveElement.Scale.Console.aceOptions, ...{minLines: 47, maxLines: 47}})
                    $this.editor.renderer.setScrollMargin(10, 10)
                    $this.editor.session.setMode($this.aceMode)
                    $this.editor.session.on('change', function() {
                        //saveButton.removeAttribute('disabled')
                        //window.LiveElement.Scale.Console.IDE.Asset.buildSnippet({body: window.btoa($this.editor.getValue())})
                    })
                    if ($this.file) {
                        $this.file.text().then(t => $this.editor.setValue(t))
                    } else if ($this.dataURL) {
                        $this.editor.setValue(window.atob($this.dataURL.split(',', 2)[1]))
                        //window.LiveElement.Scale.Console.IDE.Asset.buildSnippet({body: window.LiveElement.Scale.Console.IDE.Asset.asset.dataURL.split(',', 2)[1]})
                    }
                }
                window.LiveElement.Scale.Core.waitUntil(function() {
                    return $this.parentElement
                }).then(() => {
                    attachTextEditor()
                })
            } else {
                
            }
        }
        
        setImageEditorProperty(name, value) {
            var $this = this
            if ($this.mode != 'viewer') {
                var contentBase = ((name == 'contenttype' ? value : $this['Content-Type']) || '').split('/')[0]
                if (contentBase == 'image') {
                    var editorElement = $this.shadowRoot.querySelector('div[name="editor"]'), imageEditorElement = editorElement.querySelector('element-imageeditor')
                    $this.createEditor('image')
                    imageEditorElement = editorElement.querySelector('element-imageeditor')
                    if (imageEditorElement) {
                        imageEditorElement[name] = value
                    }
                }
            }
        }
        
        static contentTypesMap = {
            "application/epub+zip": {"suffix": "epub", "name": "Electronic publication (EPUB)"},
            "application/gzip": {"suffix": "gz", "name": "GZip Compressed Archive"},
            "application/json": {"suffix": "json", "name": "JSON format"},
            "application/ld+json": {"suffix": "jsonld", "name": "JSON-LD format"},
            "application/msword": {"suffix": "doc", "name": "Microsoft Word"},
            "application/octet-stream": {"suffix": "bin", "name": "Any kind of binary data"},
            "application/pdf": {"suffix": "pdf", "name": "Adobe Portable Document Format (PDF)"},
            "application/rtf": {"suffix": "rtf", "name": "Rich Text Format (RTF)"},
            "application/vnd.amazon.ebook": {"suffix": "azw", "name": "Amazon Kindle eBook format"},
            "application/vnd.openxmlformats-officedocument.wordprocessingml.document": {"suffix": "docx", "name": "Microsoft Word (OpenXML)"},
            "application/vnd.ms-fontobject": {"suffix": "eot", "name": "MS Embedded OpenType fonts"},
            "application/vnd.oasis.opendocument.presentation": {"suffix": "odp", "name": "OpenDocument presentation document"},
            "application/vnd.oasis.opendocument.spreadsheet": {"suffix": "ods", "name": "OpenDocument spreadsheet document"},
            "application/vnd.oasis.opendocument.text": {"suffix": "odt", "name": "OpenDocument text document"},
            "application/vnd.ms-powerpoint": {"suffix": "ppt", "name": "Microsoft PowerPoint"},
            "application/vnd.openxmlformats-officedocument.presentationml.presentation": {"suffix": "pptx", "name": "Microsoft PowerPoint (OpenXML)"},
            "application/vnd.rar": {"suffix": "rar", "name": "RAR archive"},
            "application/vnd.ms-excel": {"suffix": "xls", "name": "Microsoft Excel"},
            "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet": {"suffix": "xlsx", "name": "Microsoft Excel (OpenXML)"},
            "application/xhtml+xml": {"suffix": "xhtml", "name": "XHTML"},
            "text/xml": {"suffix": "xml", "name": "XML - Human Readable"},
            "application/x-bzip": {"suffix": "bz", "name": "BZip archive"},
            "application/x-bzip2": {"suffix": "bz2", "name": "BZip2 archive"},
            "application/x-tar": {"suffix": "tar", "name": "Tape Archive (TAR)"},
            "application/x-7z-compressed": {"suffix": "7z", "name": "7-zip archive"},
            "application/zip": {"suffix": "zip", "name": "ZIP archive"},
            "audio/aac": {"suffix": "aac", "name": "AAC audio"},
            "audio/midi": {"suffix": "mid", "name": "Musical Instrument Digital Interface (MIDI)"},
            "audio/mpeg": {"suffix": "mp3", "name": "MP3 audio"},
            "audio/ogg": {"suffix": "oga", "name": "OGG audio" },
            "audio/opus": {"suffix": "opus", "name": "Opus audio"},
            "audio/wav": {"suffix": "wav", "name": "Waveform Audio Format"},
            "audio/webm": {"suffix": "weba", "name": "WEBM audio"},
            "font/otf": {"suffix": "otf", "name": "OpenType font"},
            "font/ttf": {"suffix": "ttf", "name": "TrueType Font"},
            "font/woff": {"suffix": "woff", "name": "Web Open Font Format (WOFF)"},
            "font/woff2": {"suffix": "woff2", "name": "Web Open Font Format (WOFF)"},
            "image/bmp": {"suffix": "bmp", "name": "Windows OS/2 Bitmap Graphics"},
            "image/gif": {"suffix": "gif", "name": "Graphics Interchange Format (GIF)"},
            "image/jpeg": {"suffix": "jpeg", "name": "JPEG images"},
            "image/jpg": {"suffix": "jpg", "name": "JPEG images"},
            "image/png": {"suffix": "png", "name": "Portable Network Graphics"},
            "image/svg+xml": {"suffix": "svg", "name": "Scalable Vector Graphics"},
            "image/tiff": {"suffix": "tiff", "name": "Tagged Image File Format (TIFF)"},
            "image/vnd.microsoft.icon": {"suffix": "ico", "name": "Icon format"},
            "image/webp": {"suffix": "webp", "name": "WEBP image"},
            "text/calendar": {"suffix": "ics", "name": "iCalendar format"},
            "text/css": {"suffix": "css", "name": "Cascading Style Sheets (CSS)"},
            "text/csv": {"suffix": "csv", "name": "Comma-separated values (CSV)"},
            "text/html": {"suffix": "html", "name": "HyperText Markup Language (HTML)"},
            "text/javascript": {"suffix": "mjs", "name": "JavaScript Module" },
            "text/plain": {"suffix": "txt", "name": "Text (generally ASCII or ISO 8859-n)"},
            "text/tab-separated-values": {"suffix": "tsv", "name": "Tab-separated values (TSV)"},
            "video/mp2t": {"suffix": "ts", "name": "MPEG transport stream"},
            "video/mpeg": {"suffix": "mpeg", "name": "MPEG Video"},
            "video/mp4": {"suffix": "mp4", "name": "MP4 audio"},
            "video/ogg": {"suffix": "ogv", "name": "OGG video"},
            "video/webm": {"suffix": "webm", "name": "WEBM video"},
            "video/x-msvideo": {"suffix": "avi", "name": "AVI: Audio Video Interleave"}
        }
        
    }
</script>
