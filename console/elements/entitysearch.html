<style>
:host {
    contain: content;
    display: block;
    position: relative;
}

</style>
<template>
    <h3>Search</h3>
    <slot></slot>
    <button name="load" disabled="true">Load</button>
    <h4>History</h4>
    <ol class="history">
        <small>Reload recents from here...</small>
    </ol>
</template>
<script>
    /* global */
    class EntitySearch extends window.LiveElement.Element.elements.HTMLElement {

        static __extends = 'HTMLElement'
        static __properties = ['heading']

        constructor() {
            super()
            var $this = this
            
        }

        static get observedAttributes() {
            return (super.observedAttributes || []).concat(...this.__properties)
            
        }
        
        connectedCallback() {
            var $this = this
            var loadButton = $this.shadowRoot.querySelector('button[name="load"]')
            $this.querySelectorAll('input[type="search"][list]').forEach(searchElement => {
                if (!searchElement.getAttribute('list')) {
                    var listId = `entitysearch-${$this.getAttribute('name') || ''}-${Math.floor(Math.random()*1000000000)}`
                    var datalistElement = document.createElement('datalist')
                    datalistElement.setAttribute('id', listId)
                    $this.appendChild(datalistElement)
                    searchElement.setAttribute('list', listId)
                }
            })
            var supportingInputElements = Array.from($this.querySelectorAll('input[secondary]'))
            supportingInputElements.forEach(supportingInputElement => {
                supportingInputElement.addEventListener('change', event => {
                    if (supportingInputElements.every(i => {
                        if (i.value) {
                            var datalistElementId = i.getAttribute('list')
                            if (datalistElementId) {
                                var datalistElement = document.getElementById(datalistElementId)
                                if (datalistElement) {
                                    if (datalistElement.querySelectorAll(`option[value=${i.value}]`).length) {
                                        return true
                                    } else {
                                        return Array.from(datalistElement.querySelectorAll('option')).some(optionElement => optionElement.innerHTML == i.value)
                                    }
                                } else {
                                    return true
                                }
                            } else {
                                return true
                            }
                        } else {
                            return false
                        }
                    })) {
                        loadButton.removeAttribute('disabled')
                    } else {
                        loadButton.setAttribute('disabled', true)
                    }
                    
                })                
            })
            
            
            
        }
        
        size($this, value) {
            return value
        }
        
    }
</script>
