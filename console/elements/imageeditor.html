<style>
:host {
    contain: content;
    display: block;
    position: relative;
}

:host canvas {
    width: auto;
    height: auto;
    position: absolute;
}

::slotted(*) {
    display: none;
    
}
</style>
<template>
    <canvas></canvas>
    <slot></slot>
</template>
<script>
    /* global */
    class ImageEditor extends window.LiveElement.Element.elements.HTMLElement {

        static __extends = 'HTMLElement'
        static __properties = ['mime', 'quality']

        constructor() {
            super()
            var $this = this
            var observer = new window.MutationObserver(function() {
                var canvas = $this.shadowRoot.querySelector('canvas')
                var ctx = canvas.getContext('2d')
                ctx.clearRect(0, 0, canvas.width, canvas.height)
                $this.querySelectorAll(':scope > *').forEach(childElement => {
                    if (childElement.constructor.name == 'HTMLImageElement') {
                        childElement.addEventListener('load', event => {
                            canvas.width = childElement.naturalWidth
                            canvas.height = childElement.naturalHeight
                            canvas.setAttribute('style', `left: ${$this.parentElement.offsetWidth/2 - childElement.naturalWidth/2}px; top: ${$this.parentElement.offsetHeight/2 - childElement.naturalHeight/2}px`)
                            ctx.drawImage(childElement, 0, 0, canvas.width, canvas.height)
                            var src = childElement.getAttribute('src')
                            if (src && src.indexOf('blob:') == 0) {
                              window.URL.revokeObjectURL(src)
                            }
                        })
                    } else {
                        childElement.remove()
                    }
                })
            })
            observer.observe($this, {childList: true})
        }

        static get observedAttributes() {
            return (super.observedAttributes || []).concat('mime', 'quality')
        }
        
        connectedCallback() {
            var $this = this

        }
        
        toBlob(mime, quality) {
            var $this = this
            var mimeType = mime || $this.mime
            var dataURL = $this.toDataURL(mimeType, quality || $this.quality)
            return new window.Blob([window.atob(dataURL.slice(dataURL.indexOf(',')+1))], {type: mimeType})
        }
        
        toDataURL(mime, quality) {
            var $this = this
            return $this.shadowRoot.querySelector('canvas').toDataURL(mime || $this.mime, quality || $this.quality)
        }
        
        valueOf() {
            var $this = this
            return $this.toBlob()
        }
        
        toString() {
            var $this = this
            var dataURL = $this.toDataURL()
            return dataURL.slice(dataURL.indexOf(',')+1)
        }

    }
</script>
